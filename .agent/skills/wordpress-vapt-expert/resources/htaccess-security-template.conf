# ============================================================================
# WordPress Security Hardening - Complete .htaccess Template
# ============================================================================
#
# This is a comprehensive .htaccess security template for WordPress
# covering all 21 VAPT features that can be implemented at server level
#
# DEPLOYMENT:
# 1. Backup your existing .htaccess file
# 2. Review and customize sections marked with [CUSTOMIZE]
# 3. Test thoroughly in staging environment
# 4. Deploy to production
#
# FILE LOCATION: /public_html/.htaccess (WordPress root directory)
#
# REQUIREMENTS:
# - Apache 2.4+
# - mod_rewrite enabled
# - mod_headers enabled
# - AllowOverride All in Apache configuration
#
# ============================================================================

# BEGIN WordPress Core
# The directives (lines) between "BEGIN WordPress" and "END WordPress" are
# dynamically generated. Only modify if you know what you're doing.

<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]
    RewriteBase /
    RewriteRule ^index\.php$ - [L]
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule . /index.php [L]
</IfModule>

# END WordPress Core

# ============================================================================
# SECURITY HARDENING STARTS HERE
# ============================================================================

# ----------------------------------------------------------------------
# 1. SQL INJECTION PROTECTION
# Severity: Critical | OWASP: A03:2021
# ----------------------------------------------------------------------

<IfModule mod_rewrite.c>
    RewriteEngine On

    # Block SQL injection attempts in query strings
    RewriteCond %{QUERY_STRING} (\<|%3C).*script.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} GLOBALS(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} _REQUEST(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} (union|select|insert|drop|update|delete|replace) [NC,OR]
    RewriteCond %{QUERY_STRING} (cast|create|char|convert|alter|declare) [NC,OR]
    RewriteCond %{QUERY_STRING} (information_schema|sysdatabases|sysusers) [NC,OR]
    RewriteCond %{QUERY_STRING} (concat|group_concat|having|benchmark) [NC,OR]
    RewriteCond %{QUERY_STRING} (--|;|\'|\"|\=|\*|\(|\)|\[|\]|\{|\}) [NC,OR]
    RewriteCond %{QUERY_STRING} (0x[0-9a-f]{2,}) [NC,OR]
    RewriteCond %{QUERY_STRING} (waitfor|sleep|benchmark|MD5|SHA) [NC]
    RewriteRule ^(.*)$ - [F,L]

    # Block SQL injection in request URI
    RewriteCond %{REQUEST_URI} (union|select|insert|cast|set|declare|drop|update|delete|replace) [NC]
    RewriteRule ^(.*)$ - [F,L]
</IfModule>

# ----------------------------------------------------------------------
# 2. CROSS-SITE SCRIPTING (XSS) PROTECTION
# Severity: High | OWASP: A03:2021
# ----------------------------------------------------------------------

<IfModule mod_rewrite.c>
    # Block XSS attempts in query strings
    RewriteCond %{QUERY_STRING} (<|%3C)([^s]*s)+cript.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (<|%3C)([^e]*e)+mbed.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (<|%3C)([^o]*o)+bject.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (<|%3C)([^i]*i)+frame.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} base64_(en|de)code\(.*\) [NC,OR]
    RewriteCond %{QUERY_STRING} javascript\: [NC,OR]
    RewriteCond %{QUERY_STRING} (\<|%3C).*style.*(\>|%3E).*(\<|%3C).*\/.*style.*(\>|%3E) [NC]
    RewriteRule ^(.*)$ - [F,L]
</IfModule>

# ----------------------------------------------------------------------
# 3. SECURITY HEADERS
# Severity: Medium | OWASP: A05:2021
# ----------------------------------------------------------------------

<IfModule mod_headers.c>
    # Prevent clickjacking
    Header always set X-Frame-Options "SAMEORIGIN"

    # Prevent MIME sniffing
    Header always set X-Content-Type-Options "nosniff"

    # Enable XSS Protection (legacy, but still useful)
    Header always set X-XSS-Protection "1; mode=block"

    # Force HTTPS (only if SSL is enabled)
    <If "%{HTTPS} == 'on'">
        Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    </If>

    # Content Security Policy
    # [CUSTOMIZE] Adjust CSP based on your third-party resources
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.google.com https://www.gstatic.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' data: https://fonts.gstatic.com; img-src 'self' data: https: http:; connect-src 'self'; frame-src 'self' https://www.youtube.com; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'self'; upgrade-insecure-requests;"

    # Referrer Policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Permissions Policy
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=(), accelerometer=(), fullscreen=(self)"

    # Remove server signature
    Header unset Server
    Header always unset X-Powered-By
    Header unset X-Powered-By
</IfModule>

# ----------------------------------------------------------------------
# 4. DISABLE XML-RPC
# Severity: Medium | Feature: XML-RPC Protection
# ----------------------------------------------------------------------

# Block access to xmlrpc.php completely
<Files xmlrpc.php>
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order deny,allow
        Deny from all
    </IfModule>
</Files>

# Alternative: Block only POST requests to xmlrpc.php
# <FilesMatch "^(xmlrpc\.php)$">
#     <IfModule mod_rewrite.c>
#         RewriteEngine On
#         RewriteCond %{REQUEST_METHOD} POST
#         RewriteRule .* - [F,L]
#     </IfModule>
# </FilesMatch>

# ----------------------------------------------------------------------
# 5. DISABLE USER ENUMERATION
# Severity: Low | Feature: Information Disclosure Prevention
# ----------------------------------------------------------------------

<IfModule mod_rewrite.c>
    # Block author scanning via /?author=N
    RewriteCond %{QUERY_STRING} ^author=([0-9]*) [NC]
    RewriteRule .* - [F,L]

    # Block author archive access
    RewriteCond %{REQUEST_URI} ^/author/ [NC]
    RewriteRule .* - [F,L]
</IfModule>

# ----------------------------------------------------------------------
# 6. RATE LIMITING (Basic Implementation)
# Severity: Medium | Feature: Brute Force Protection
# ----------------------------------------------------------------------

# Note: For advanced rate limiting, consider using fail2ban or ModSecurity
# This provides basic protection by limiting request methods

<IfModule mod_rewrite.c>
    # Limit rapid POST requests (basic protection)
    # For better protection, use fail2ban or mod_evasive

    # Block requests with suspicious user agents
    RewriteCond %{HTTP_USER_AGENT} ^$ [OR]
    RewriteCond %{HTTP_USER_AGENT} ^(-|.*(<|>|%3C|%3E).*)$ [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} (libwww-perl|wget|python|nikto|curl|scan|java|winhttp|clshttp|loader) [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} (;|<|>|'|"|\)|\(|%0A|%0D|%27|%3C|%3E|%00) [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} (base64_decode|bin/bash|disconnect|eval|lwp-download|unserialize|\\\x22) [NC]
    RewriteRule ^(.*)$ - [F,L]
</IfModule>

# ----------------------------------------------------------------------
# 7. PROTECT wp-config.php
# Severity: Critical | Feature: Configuration Security
# ----------------------------------------------------------------------

<Files wp-config.php>
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order deny,allow
        Deny from all
    </IfModule>
</Files>

# Protect wp-config backup files
<FilesMatch "wp-config\.php\.(bak|save|old|backup|swp|tmp)$">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order deny,allow
        Deny from all
    </IfModule>
</FilesMatch>

# ----------------------------------------------------------------------
# 8. PROTECT SENSITIVE FILES
# Severity: High | Feature: Information Disclosure Prevention
# ----------------------------------------------------------------------

# Protect readme.html, license.txt, and other info files
<FilesMatch "^(readme\.(html|txt)|license\.txt|wp-config-sample\.php)$">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order deny,allow
        Deny from all
    </IfModule>
</FilesMatch>

# Protect .htaccess and .htpasswd
<FilesMatch "^\.ht">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order deny,allow
        Deny from all
    </IfModule>
</FilesMatch>

# Protect log files
<FilesMatch "\.(log|sql|gz|tar|bak|save|swp|old|tmp)$">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order deny,allow
        Deny from all
    </IfModule>
</FilesMatch>

# ----------------------------------------------------------------------
# 9. DISABLE DIRECTORY LISTING
# Severity: Low | Feature: Information Disclosure Prevention
# ----------------------------------------------------------------------

Options -Indexes

# Alternative with error document
# Options -Indexes
# ErrorDocument 403 /403.html

# ----------------------------------------------------------------------
# 10. PROTECT wp-includes
# Severity: Medium | Feature: Access Control
# ----------------------------------------------------------------------

<IfModule mod_rewrite.c>
    # Block direct access to PHP files in wp-includes
    RewriteRule ^wp-includes/[^/]+\.php$ - [F,L]

    # Allow these specific files
    RewriteRule ^wp-includes/ms-files\.php$ - [L]

    # Block access to theme/plugin files
    RewriteRule ^wp-content/plugins/(.*\.php)$ - [F,L]
    RewriteRule ^wp-content/themes/(.*\.php)$ - [F,L]
</IfModule>

# ----------------------------------------------------------------------
# 11. DISABLE PHP EXECUTION IN UPLOADS
# Severity: Critical | Feature: File Upload Security
# ----------------------------------------------------------------------

# Prevent PHP execution in wp-content/uploads
<Directory "/var/www/html/wp-content/uploads/">
    <FilesMatch "\.php$">
        <IfModule mod_authz_core.c>
            Require all denied
        </IfModule>
        <IfModule !mod_authz_core.c>
            Order deny,allow
            Deny from all
        </IfModule>
    </FilesMatch>
</Directory>

# Alternative method using mod_rewrite
<IfModule mod_rewrite.c>
    RewriteRule ^wp-content/uploads/.*\.php$ - [F,L]
</IfModule>

# ----------------------------------------------------------------------
# 12. BLOCK BAD BOTS AND SCRAPERS
# Severity: Low | Feature: Rate Limiting / DDoS Protection
# ----------------------------------------------------------------------

<IfModule mod_rewrite.c>
    # Block known bad bots
    RewriteCond %{HTTP_USER_AGENT} (ahrefs|semrush|majestic|mj12bot|rogerbot) [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} (sqlmap|nikto|nmap|nessus|openvas) [NC]
    RewriteRule ^(.*)$ - [F,L]
</IfModule>

# ----------------------------------------------------------------------
# 13. PROTECT AGAINST REQUEST METHOD ATTACKS
# Severity: Medium | Feature: HTTP Method Security
# ----------------------------------------------------------------------

<IfModule mod_rewrite.c>
    # Only allow GET, POST, and HEAD requests
    RewriteCond %{REQUEST_METHOD} !^(GET|POST|HEAD)$ [NC]
    RewriteRule ^(.*)$ - [F,L]
</IfModule>

# ----------------------------------------------------------------------
# 14. CRON PROTECTION
# Severity: Low | Feature: wp-cron.php Security
# ----------------------------------------------------------------------

# If you're using system cron instead of wp-cron, block direct access
# [CUSTOMIZE] Uncomment if using system cron

# <Files wp-cron.php>
#     <IfModule mod_authz_core.c>
#         Require all denied
#     </IfModule>
#     <IfModule !mod_authz_core.c>
#         Order deny,allow
#         Deny from all
#     </IfModule>
# </Files>

# If using wp-cron but want to prevent abuse
<IfModule mod_rewrite.c>
    # Limit wp-cron access (allow only from localhost or specific IPs)
    # [CUSTOMIZE] Add your server IP if needed
    RewriteCond %{REQUEST_URI} ^/wp-cron\.php [NC]
    RewriteCond %{REMOTE_ADDR} !^127\.0\.0\.1$
    # RewriteCond %{REMOTE_ADDR} !^YOUR\.SERVER\.IP\.HERE$
    # RewriteRule .* - [F,L]
</IfModule>

# ----------------------------------------------------------------------
# 15. PROTECT AGAINST HOTLINKING
# Severity: Low | Feature: Bandwidth Protection
# ----------------------------------------------------------------------

# [CUSTOMIZE] Replace example.com with your domain

# <IfModule mod_rewrite.c>
#     RewriteCond %{HTTP_REFERER} !^$
#     RewriteCond %{HTTP_REFERER} !^https?://(www\.)?example\.com [NC]
#     RewriteRule \.(jpg|jpeg|png|gif|webp|svg|css|js)$ - [F,L]
# </IfModule>

# ----------------------------------------------------------------------
# 16. FORCE SSL/HTTPS
# Severity: High | Feature: Encryption in Transit
# ----------------------------------------------------------------------

# [CUSTOMIZE] Uncomment to force HTTPS site-wide

# <IfModule mod_rewrite.c>
#     RewriteCond %{HTTPS} off
#     RewriteRule ^(.*)$ https://%{HTTP_HOST}/$1 [R=301,L]
# </IfModule>

# Force HTTPS for admin area only
<IfModule mod_rewrite.c>
    RewriteCond %{HTTPS} off
    RewriteCond %{REQUEST_URI} ^/wp-admin [NC]
    RewriteRule ^(.*)$ https://%{HTTP_HOST}/$1 [R=301,L]
</IfModule>

# ----------------------------------------------------------------------
# 17. PREVENT ACCESS TO VERSION CONTROL FILES
# Severity: High | Feature: Information Disclosure Prevention
# ----------------------------------------------------------------------

<IfModule mod_rewrite.c>
    # Block access to .git, .svn, .hg directories
    RewriteRule "(^|/)\.git" - [F,L]
    RewriteRule "(^|/)\.svn" - [F,L]
    RewriteRule "(^|/)\.hg" - [F,L]
</IfModule>

# ----------------------------------------------------------------------
# 18. BLOCK FILE INJECTION
# Severity: High | Feature: Remote File Inclusion Protection
# ----------------------------------------------------------------------

<IfModule mod_rewrite.c>
    # Block requests with file paths
    RewriteCond %{QUERY_STRING} \.\.\/ [NC,OR]
    RewriteCond %{QUERY_STRING} \.\.\\ [NC,OR]
    RewriteCond %{QUERY_STRING} ^.*\.(bash|git|hg|log|svn|swp|cvs) [NC,OR]
    RewriteCond %{QUERY_STRING} etc/passwd [NC,OR]
    RewriteCond %{QUERY_STRING} boot\.ini [NC]
    RewriteRule ^(.*)$ - [F,L]

    # Block various file types in query string
    RewriteCond %{QUERY_STRING} \.(php|asp|aspx|jsp|cgi|pl)(\.|%2e) [NC]
    RewriteRule ^(.*)$ - [F,L]
</IfModule>

# ----------------------------------------------------------------------
# 19. DISABLE TRACE AND TRACK
# Severity: Medium | Feature: HTTP Method Security
# ----------------------------------------------------------------------

<IfModule mod_rewrite.c>
    RewriteCond %{REQUEST_METHOD} ^(TRACE|TRACK)
    RewriteRule .* - [F,L]
</IfModule>

# ----------------------------------------------------------------------
# 20. PROTECT AGAINST PROXY HEADER INJECTION
# Severity: Medium | Feature: Header Injection Protection
# ----------------------------------------------------------------------

<IfModule mod_headers.c>
    # Remove proxy headers that could be injected
    RequestHeader unset Proxy early
    RequestHeader unset X-Forwarded-Host
    RequestHeader unset X-Forwarded-Server
</IfModule>

# ----------------------------------------------------------------------
# 21. FILE UPLOAD RESTRICTIONS
# Severity: High | Feature: File Upload Security
# ----------------------------------------------------------------------

# Limit file upload size (if PHP allows)
<IfModule mod_php7.c>
    php_value upload_max_filesize 10M
    php_value post_max_size 10M
</IfModule>

# Block executable files in uploads
<FilesMatch "\.(php|phtml|php3|php4|php5|phps|exe|pl|cgi|sh|bat)$">
    <IfModule mod_authz_core.c>
        <RequireAll>
            Require not uri /wp-content/uploads/
        </RequireAll>
    </IfModule>
</FilesMatch>

# ============================================================================
# PERFORMANCE OPTIMIZATIONS (OPTIONAL)
# ============================================================================

# ----------------------------------------------------------------------
# Browser Caching
# ----------------------------------------------------------------------

<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType application/pdf "access plus 1 month"
    ExpiresByType text/x-javascript "access plus 1 month"
    ExpiresByType image/x-icon "access plus 1 year"
    ExpiresDefault "access plus 2 days"
</IfModule>

# ----------------------------------------------------------------------
# Compression
# ----------------------------------------------------------------------

<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css
    AddOutputFilterByType DEFLATE application/xml application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript text/javascript
</IfModule>

# ============================================================================
# CUSTOM ERROR PAGES (OPTIONAL)
# ============================================================================

# [CUSTOMIZE] Create custom error pages and update paths

# ErrorDocument 403 /403.html
# ErrorDocument 404 /404.html
# ErrorDocument 500 /500.html

# ============================================================================
# IP WHITELISTING FOR ADMIN AREA (OPTIONAL)
# ============================================================================

# [CUSTOMIZE] Uncomment and add your IP addresses

# <FilesMatch "wp-login\.php">
#     <IfModule mod_authz_core.c>
#         Require ip 192.168.1.1
#         Require ip 203.0.113.0/24
#     </IfModule>
#     <IfModule !mod_authz_core.c>
#         Order deny,allow
#         Deny from all
#         Allow from 192.168.1.1
#         Allow from 203.0.113.0/24
#     </IfModule>
# </FilesMatch>

# ============================================================================
# TESTING AND VERIFICATION
# ============================================================================

# After deploying this .htaccess file:
#
# 1. Test Apache configuration:
#    apache2ctl configtest
#
# 2. Check if site loads properly:
#    curl -I https://example.com
#
# 3. Test specific security features:
#    - SQL Injection: curl -I "https://example.com/?id=1' OR '1'='1"
#    - XSS: curl -I "https://example.com/?search=<script>alert('xss')</script>"
#    - XML-RPC: curl -X POST https://example.com/xmlrpc.php
#    - wp-config: curl -I https://example.com/wp-config.php
#
# 4. Use online security scanners:
#    - https://securityheaders.com
#    - https://observatory.mozilla.org
#    - wpscan --url https://example.com
#
# 5. Monitor error logs:
#    tail -f /var/log/apache2/error.log
#
# ============================================================================
# TROUBLESHOOTING
# ============================================================================

# If you experience issues:
#
# 1. 500 Internal Server Error:
#    - Check Apache error log for specific issues
#    - Verify mod_rewrite and mod_headers are enabled
#    - Ensure AllowOverride is set correctly
#
# 2. 403 Forbidden on legitimate requests:
#    - Review rules that might be blocking valid traffic
#    - Check IP whitelist restrictions
#    - Temporarily disable sections to identify culprit
#
# 3. Features not working:
#    - Clear browser cache
#    - Test in incognito mode
#    - Verify .htaccess is being read (add test rule)
#
# ============================================================================
# MAINTENANCE NOTES
# ============================================================================

# Regular maintenance tasks:
# - Review and update security rules monthly
# - Test after WordPress core/plugin updates
# - Monitor error logs for false positives
# - Update IP whitelists as needed
# - Keep this file backed up
#
# Last Updated: 2024-01-18
# Next Review: 2024-04-18
#
# ============================================================================
