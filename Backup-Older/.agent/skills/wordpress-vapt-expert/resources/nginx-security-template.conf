# ============================================================================
# WordPress Security Hardening - Complete nginx Configuration Template
# ============================================================================
#
# This is a comprehensive nginx security template for WordPress
# covering all 21 VAPT features that can be implemented at server level
#
# DEPLOYMENT:
# 1. Backup your existing nginx configuration
# 2. Review and customize sections marked with [CUSTOMIZE]
# 3. Test configuration: sudo nginx -t
# 4. Test in staging environment
# 5. Reload nginx: sudo systemctl reload nginx
#
# FILE LOCATION: /etc/nginx/sites-available/your-site.conf
# (or /etc/nginx/conf.d/wordpress-security.conf)
#
# REQUIREMENTS:
# - nginx 1.18+ (preferably 1.20+)
# - OpenSSL for HTTPS
# - ngx_http_headers_module (usually included)
# - ngx_http_rewrite_module (usually included)
#
# ============================================================================

# ----------------------------------------------------------------------
# Rate Limiting Zones (Define before server blocks)
# ----------------------------------------------------------------------

# General request rate limiting
limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;

# Login page rate limiting
limit_req_zone $binary_remote_addr zone=login:10m rate=2r/m;

# API rate limiting
limit_req_zone $binary_remote_addr zone=api:10m rate=30r/m;

# XML-RPC rate limiting
limit_req_zone $binary_remote_addr zone=xmlrpc:10m rate=1r/m;

# Connection limiting
limit_conn_zone $binary_remote_addr zone=addr:10m;

# ----------------------------------------------------------------------
# Security Maps (SQL Injection & XSS Detection)
# ----------------------------------------------------------------------

# Map for SQL Injection detection in URI
map $request_uri $is_sqli_uri {
    default 0;
    "~*union.*select" 1;
    "~*insert.*into" 1;
    "~*drop.*table" 1;
    "~*update.*set" 1;
    "~*delete.*from" 1;
    "~*concat.*\(" 1;
    "~*information_schema" 1;
    "~*benchmark.*\(" 1;
    "~*sleep.*\(" 1;
    "~*waitfor.*delay" 1;
    "~*0x[0-9a-f]" 1;
}

# Map for SQL Injection detection in query string
map $args $is_sqli_args {
    default 0;
    "~*union.*select" 1;
    "~*insert.*into" 1;
    "~*(\'|\"|\-\-|\#)" 1;
    "~*concat.*\(" 1;
    "~*information_schema" 1;
    "~*0x[0-9a-f]{2,}" 1;
    "~*waitfor.*delay" 1;
    "~*benchmark.*\(" 1;
    "~*cast.*\(" 1;
    "~*exec.*\(" 1;
}

# Map for XSS detection
map $request_uri $is_xss {
    default 0;
    "~*<script" 1;
    "~*javascript:" 1;
    "~*onerror=" 1;
    "~*onload=" 1;
    "~*<iframe" 1;
    "~*<embed" 1;
    "~*<object" 1;
}

# Map for bad user agents
map $http_user_agent $bad_bot {
    default 0;
    "~*(libwww-perl|wget|python|nikto|curl|scan|java|winhttp|clshttp|loader)" 1;
    "~*(ahrefs|semrush|majestic|mj12bot|rogerbot)" 1;
    "~*(sqlmap|nmap|nessus|openvas)" 1;
    "~*^$" 1;
}

# Map for file injection detection
map $args $is_file_injection {
    default 0;
    "~*\.\.\/" 1;
    "~*\.\.\\" 1;
    "~*etc/passwd" 1;
    "~*boot\.ini" 1;
    "~*\.(bash|git|hg|log|svn|swp|cvs)" 1;
}

# ============================================================================
# HTTP to HTTPS Redirect
# ============================================================================

server {
    listen 80;
    listen [::]:80;

    # [CUSTOMIZE] Replace with your domain
    server_name example.com www.example.com;

    # Redirect all HTTP to HTTPS
    return 301 https://$server_name$request_uri;
}

# ============================================================================
# Main HTTPS Server Block
# ============================================================================

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    # [CUSTOMIZE] Replace with your domain
    server_name example.com www.example.com;

    # [CUSTOMIZE] Replace with your document root
    root /var/www/html;

    index index.php index.html index.htm;

    # Access and error logs
    access_log /var/log/nginx/wordpress-access.log;
    error_log /var/log/nginx/wordpress-error.log;

    # ----------------------------------------------------------------------
    # SSL Configuration
    # ----------------------------------------------------------------------

    # [CUSTOMIZE] Replace with your SSL certificate paths
    ssl_certificate /etc/ssl/certs/your-certificate.crt;
    ssl_certificate_key /etc/ssl/private/your-private-key.key;

    # SSL protocols and ciphers (TLS 1.2 and 1.3 only)
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers off;

    # SSL session caching
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:50m;
    ssl_session_tickets off;

    # OCSP stapling
    ssl_stapling on;
    ssl_stapling_verify on;
    ssl_trusted_certificate /etc/ssl/certs/ca-certificates.crt;

    # DNS resolver for OCSP
    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 5s;

    # ----------------------------------------------------------------------
    # Security Headers
    # Severity: Medium | OWASP: A05:2021
    # ----------------------------------------------------------------------

    # X-Frame-Options: Prevent clickjacking
    add_header X-Frame-Options "SAMEORIGIN" always;

    # X-Content-Type-Options: Prevent MIME sniffing
    add_header X-Content-Type-Options "nosniff" always;

    # X-XSS-Protection: Legacy XSS protection
    add_header X-XSS-Protection "1; mode=block" always;

    # Strict-Transport-Security: Force HTTPS
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # Content-Security-Policy: XSS and injection protection
    # [CUSTOMIZE] Adjust based on your third-party resources
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.google.com https://www.gstatic.com https://ajax.googleapis.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' data: https://fonts.gstatic.com; img-src 'self' data: https: http:; connect-src 'self'; frame-src 'self' https://www.youtube.com https://www.google.com; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'self'; upgrade-insecure-requests;" always;

    # Referrer-Policy: Control referrer information
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Permissions-Policy: Control browser features
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=(), accelerometer=(), fullscreen=(self)" always;

    # Expect-CT: Certificate Transparency
    add_header Expect-CT "max-age=86400, enforce" always;

    # Cross-Origin Policies
    add_header Cross-Origin-Embedder-Policy "require-corp" always;
    add_header Cross-Origin-Opener-Policy "same-origin" always;
    add_header Cross-Origin-Resource-Policy "same-origin" always;

    # Remove server signature
    server_tokens off;
    more_clear_headers Server;

    # ----------------------------------------------------------------------
    # Global Security Blocks
    # ----------------------------------------------------------------------

    # Block SQL Injection attempts
    if ($is_sqli_uri) {
        return 403;
    }

    if ($is_sqli_args) {
        return 403;
    }

    # Block XSS attempts
    if ($is_xss) {
        return 403;
    }

    # Block bad bots
    if ($bad_bot) {
        return 403;
    }

    # Block file injection attempts
    if ($is_file_injection) {
        return 403;
    }

    # Block requests with no User-Agent or suspicious patterns
    if ($http_user_agent ~* (;|<|>|'|"|\)|\(|%0A|%0D|%27|%3C|%3E|%00)) {
        return 403;
    }

    # Block trace and track methods
    if ($request_method ~* ^(TRACE|TRACK)$) {
        return 405;
    }

    # Only allow specific HTTP methods
    if ($request_method !~ ^(GET|HEAD|POST|PUT|DELETE|OPTIONS)$) {
        return 405;
    }

    # ----------------------------------------------------------------------
    # Rate Limiting
    # Severity: Medium | Feature: Brute Force Protection
    # ----------------------------------------------------------------------

    # General rate limiting (burst allows 20 requests)
    limit_req zone=general burst=20 nodelay;

    # Connection limit (10 connections per IP)
    limit_conn addr 10;

    # ----------------------------------------------------------------------
    # WordPress Core Files
    # ----------------------------------------------------------------------

    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    # ----------------------------------------------------------------------
    # Disable User Enumeration
    # Severity: Low | Feature: Information Disclosure Prevention
    # ----------------------------------------------------------------------

    # Block author scanning
    location ~ ^/author/ {
        return 403;
    }

    # Block ?author=N queries
    if ($args ~* "author=\d+") {
        return 403;
    }

    # ----------------------------------------------------------------------
    # Protect Sensitive Files
    # Severity: Critical | Feature: Configuration Security
    # ----------------------------------------------------------------------

    # Protect wp-config.php
    location ~ /wp-config\.php {
        deny all;
    }

    # Protect wp-config backups
    location ~ /wp-config\.(bak|save|old|backup|swp|tmp) {
        deny all;
    }

    # Protect readme and license files
    location ~ ^/(readme|license)\.(html|txt) {
        deny all;
    }

    # Protect wp-config-sample
    location ~ /wp-config-sample\.php {
        deny all;
    }

    # Protect .htaccess and .htpasswd
    location ~ /\.ht {
        deny all;
    }

    # Protect log files
    location ~ \.(log|sql|gz|tar|bak|save|swp|old|tmp)$ {
        deny all;
    }

    # ----------------------------------------------------------------------
    # Disable XML-RPC
    # Severity: Medium | Feature: XML-RPC Protection
    # ----------------------------------------------------------------------

    # Completely block xmlrpc.php
    location = /xmlrpc.php {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Alternative: Rate limit XML-RPC instead of blocking
    # location = /xmlrpc.php {
    #     limit_req zone=xmlrpc burst=1 nodelay;
    #     include snippets/fastcgi-php.conf;
    #     fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
    # }

    # ----------------------------------------------------------------------
    # Protect wp-cron.php
    # Severity: Low | Feature: Cron Protection
    # ----------------------------------------------------------------------

    # If using system cron, block wp-cron.php
    # [CUSTOMIZE] Uncomment if using system cron

    # location = /wp-cron.php {
    #     deny all;
    # }

    # If using wp-cron, allow only from localhost
    location = /wp-cron.php {
        allow 127.0.0.1;
        # [CUSTOMIZE] Add your server IP if needed
        # allow YOUR.SERVER.IP.HERE;
        deny all;
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
    }

    # ----------------------------------------------------------------------
    # Disable REST API (Optional)
    # Severity: Medium | Feature: REST API Protection
    # ----------------------------------------------------------------------

    # Block unauthenticated REST API access
    # [CUSTOMIZE] Uncomment to enable

    # location ~ ^/wp-json/ {
    #     deny all;
    # }

    # Alternative: Allow only authenticated users
    location ~ ^/wp-json/wp/v2/users {
        deny all;
    }

    # ----------------------------------------------------------------------
    # Protect wp-includes
    # Severity: Medium | Feature: Access Control
    # ----------------------------------------------------------------------

    # Block direct access to PHP files in wp-includes
    location ~ ^/wp-includes/.*\.php$ {
        deny all;
    }

    # Allow specific files
    location = /wp-includes/ms-files.php {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
    }

    # ----------------------------------------------------------------------
    # Protect Plugin and Theme Files
    # Severity: Medium | Feature: Access Control
    # ----------------------------------------------------------------------

    # Block direct access to plugin PHP files
    location ~ ^/wp-content/plugins/.*\.php$ {
        deny all;
    }

    # Block direct access to theme PHP files
    location ~ ^/wp-content/themes/.*\.php$ {
        deny all;
    }

    # ----------------------------------------------------------------------
    # Disable PHP Execution in Uploads
    # Severity: Critical | Feature: File Upload Security
    # ----------------------------------------------------------------------

    # Prevent PHP execution in wp-content/uploads
    location ~* ^/wp-content/uploads/.*\.(php|php3|php4|php5|phtml|pl|py|jsp|asp|sh|cgi)$ {
        deny all;
    }

    # ----------------------------------------------------------------------
    # Login Page Protection
    # Severity: High | Feature: Brute Force Protection
    # ----------------------------------------------------------------------

    location = /wp-login.php {
        # Rate limiting for login attempts
        limit_req zone=login burst=2 nodelay;

        # [CUSTOMIZE] Optional: Whitelist specific IPs
        # allow 192.168.1.1;
        # allow 203.0.113.0/24;
        # deny all;

        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
    }

    # Admin area rate limiting
    location ~ ^/wp-admin/ {
        limit_req zone=general burst=30 nodelay;

        # [CUSTOMIZE] Optional: IP whitelist
        # allow 192.168.1.1;
        # deny all;

        location ~ \.php$ {
            include snippets/fastcgi-php.conf;
            fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
        }
    }

    # ----------------------------------------------------------------------
    # Version Control and Hidden Files
    # Severity: High | Feature: Information Disclosure Prevention
    # ----------------------------------------------------------------------

    # Block access to .git, .svn, .hg directories
    location ~ /\.(git|svn|hg) {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Block all hidden files (starting with .)
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # ----------------------------------------------------------------------
    # PHP Processing
    # ----------------------------------------------------------------------

    location ~ \.php$ {
        # Security: Don't run PHP in uploads directory
        if ($request_uri ~* "^/wp-content/uploads/") {
            return 403;
        }

        include snippets/fastcgi-php.conf;

        # [CUSTOMIZE] Adjust PHP-FPM socket path for your PHP version
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;

        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;

        # Security headers for PHP responses
        fastcgi_hide_header X-Powered-By;

        # Increase timeouts for heavy operations
        fastcgi_read_timeout 300;
    }

    # ----------------------------------------------------------------------
    # Static File Handling & Caching
    # ----------------------------------------------------------------------

    # Handle static files
    location ~* \.(js|css|png|jpg|jpeg|gif|webp|svg|ico|pdf|html|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
        log_not_found off;
    }

    # Prevent hotlinking of images
    # [CUSTOMIZE] Replace example.com with your domain
    # location ~* \.(jpg|jpeg|png|gif|webp)$ {
    #     valid_referers none blocked example.com *.example.com;
    #     if ($invalid_referer) {
    #         return 403;
    #     }
    # }

    # ----------------------------------------------------------------------
    # Favicon and Robots
    # ----------------------------------------------------------------------

    location = /favicon.ico {
        access_log off;
        log_not_found off;
    }

    location = /robots.txt {
        access_log off;
        log_not_found off;
        allow all;
    }

    # ----------------------------------------------------------------------
    # Security: Deny Access to Backup Files
    # ----------------------------------------------------------------------

    location ~* \.(bak|backup|old|save|swo|swp|sql|tar|tgz|gz)$ {
        deny all;
    }
}

# ============================================================================
# Additional Security Configurations (Optional Include Files)
# ============================================================================

# You can split these into separate include files:
# include /etc/nginx/security/sql-injection.conf;
# include /etc/nginx/security/xss-protection.conf;
# include /etc/nginx/security/rate-limiting.conf;

# ============================================================================
# Testing and Verification
# ============================================================================

# After deploying this configuration:
#
# 1. Test nginx configuration:
#    sudo nginx -t
#
# 2. Reload nginx:
#    sudo systemctl reload nginx
#    (or: sudo service nginx reload)
#
# 3. Test site accessibility:
#    curl -I https://example.com
#
# 4. Test specific security features:
#    - SQL Injection: curl -I "https://example.com/?id=1' OR '1'='1"
#    - XSS: curl -I "https://example.com/?search=<script>alert('xss')</script>"
#    - XML-RPC: curl -X POST https://example.com/xmlrpc.php
#    - wp-config: curl -I https://example.com/wp-config.php
#    - User enum: curl -I "https://example.com/?author=1"
#
# 5. Check security headers:
#    curl -I https://example.com | grep -i "x-frame-options\|x-content-type\|strict-transport"
#
# 6. Use online security scanners:
#    - https://securityheaders.com
#    - https://observatory.mozilla.org
#    - wpscan --url https://example.com
#
# 7. Monitor logs:
#    sudo tail -f /var/log/nginx/wordpress-error.log
#    sudo tail -f /var/log/nginx/wordpress-access.log
#
# ============================================================================
# Troubleshooting
# ============================================================================

# Common issues and solutions:
#
# 1. 502 Bad Gateway:
#    - Check PHP-FPM is running: systemctl status php8.1-fpm
#    - Verify socket path in fastcgi_pass directive
#    - Check PHP-FPM error log: /var/log/php8.1-fpm.log
#
# 2. 403 Forbidden on legitimate requests:
#    - Check error log for which rule is blocking
#    - Review security maps and if conditions
#    - Temporarily disable specific blocks to identify issue
#
# 3. Rate limiting too aggressive:
#    - Increase burst parameter in limit_req
#    - Adjust rate in limit_req_zone
#    - Check: grep "limiting requests" /var/log/nginx/error.log
#
# 4. SSL errors:
#    - Verify certificate paths
#    - Test SSL: openssl s_client -connect example.com:443
#    - Use SSL Labs test: https://www.ssllabs.com/ssltest/
#
# 5. Performance issues:
#    - Enable gzip compression
#    - Optimize rate limiting zones
#    - Increase worker_processes and worker_connections
#
# ============================================================================
# Maintenance Notes
# ============================================================================

# Regular maintenance tasks:
# - Review and update security rules monthly
# - Monitor error logs for blocked legitimate requests
# - Update SSL certificates before expiration
# - Test after nginx updates
# - Adjust rate limits based on traffic patterns
# - Keep configuration backed up
#
# Configuration best practices:
# - Test changes in staging before production
# - Use include files for better organization
# - Document all customizations
# - Version control your configurations
# - Monitor performance impact of security rules
#
# Last Updated: 2024-01-18
# Next Review: 2024-04-18
#
# ============================================================================
