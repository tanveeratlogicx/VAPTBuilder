const puppeteer = require('puppeteer');
const fs = require('fs');

async function takeScreenshot() {
  const url = process.argv[2];
  const outputPath = process.argv[3];
  const evidenceJson = process.argv[4]; // Optional JSON evidence

  if (!url || !outputPath) {
    console.error('Usage: node take-screenshot.js <url> <output_path> [evidence_json]');
    process.exit(1);
  }

  let browser;
  try {
    browser = await puppeteer.launch({
      headless: "new",
      args: ['--no-sandbox', '--disable-setuid-sandbox']
    });
    const page = await browser.newPage();
    await page.setViewport({ width: 1000, height: 800 });

    if (evidenceJson) {
      // Render Audit View
      let evidence;
      try {
        evidence = JSON.parse(evidenceJson);
      } catch (e) {
        evidence = { type: 'text', content: evidenceJson };
      }

      // Helper to escape HTML to prevent rendering issues
      const escapeHtml = (unsafe) => {
        if (typeof unsafe !== 'string') return unsafe;
        return unsafe
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      };

      const safeContent = escapeHtml(evidence.content);
      const safeNotes = escapeHtml(evidence.notes);
      const safeFilename = escapeHtml(evidence.filename);

      let htmlContent = `
            <!DOCTYPE html>
            <html>
            <head>
                <style>
                    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f0f2f5; padding: 40px; color: #1c1e21; line-height: 1.5; }
                    .report-card { background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden; border: 1px solid #ddd; }
                    .header { background: #2271b1; color: white; padding: 20px; }
                    .header h1 { margin: 0; font-size: 20px; }
                    .header p { margin: 5px 0 0; opacity: 0.8; font-size: 14px; word-break: break-all; }
                    .content { padding: 30px; }
                    .section-title { font-weight: 700; font-size: 14px; text-transform: uppercase; color: #646970; margin-bottom: 15px; border-bottom: 2px solid #f0f2f5; padding-bottom: 8px; }
                    .data-box { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 6px; padding: 15px; font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace; font-size: 13px; white-space: pre-wrap; word-break: break-all; }
                    .status-badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; margin-bottom: 20px; }
                    .status-fail { background: #fbeaea; color: #d63638; border: 1px solid #ebcfcf; }
                    .footer { padding: 15px 30px; background: #fafbfc; border-top: 1px solid #eee; text-align: right; font-size: 11px; color: #999; }
                    .highlight { background: #fff8e5; border-left: 4px solid #ffb900; padding: 10px; margin: 10px 0; }
                </style>
            </head>
            <body>
                <div class="report-card">
                    <div class="header">
                        <h1>VAPT Conclusive Evidence</h1>
                        <p>Target: ${url}</p>
                    </div>
                    <div class="content">
                        <div class="status-badge status-fail">VULNERABILITY CONFIRMED</div>
                        
                        ${evidence.type === 'file_exposure' ? `
                            <div class="section-title">Sensitive File Exposed</div>
                            <div class="highlight">
                                <strong>Direct Access to Sensitive File:</strong> <code>${safeFilename}</code>
                            </div>
                            <div class="section-title">File Content Preview</div>
                            <div class="data-box" style="background: #1e1e1e; color: #d4d4d4; padding: 20px; border: none; font-size: 12px;">${safeContent}</div>
                        ` : `
                            <div class="section-title">${evidence.type === 'headers' ? 'HTTP Response Headers' : 'Technical Proof'}</div>
                            <div class="data-box">${safeContent}</div>
                        `}
                        
                        ${safeNotes ? `<div class="highlight"><strong>Audit Note:</strong> ${safeNotes}</div>` : ''}
                    </div>
                    <div class="footer">
                        Generated by VAPT Auditor Puppeteer Engine on ${new Date().toUTCString()}
                    </div>
                </div>
            </body>
            </html>`;

      await page.setContent(htmlContent);
      // Wait for any subtle rendering
      await new Promise(r => setTimeout(r, 500));
    } else {
      // Standard URL Screenshot
      await page.goto(url, { waitUntil: 'networkidle2', timeout: 30000 });
    }

    // Take screenshot
    const element = evidenceJson ? await page.$('.report-card') : null;
    if (element) {
      await element.screenshot({ path: outputPath });
    } else {
      await page.screenshot({ path: outputPath });
    }

    console.log(`Screenshot saved to: ${outputPath}`);
  } catch (error) {
    console.error('Error taking screenshot:', error.message);
    process.exit(1);
  } finally {
    if (browser) await browser.close();
  }
}

takeScreenshot();
